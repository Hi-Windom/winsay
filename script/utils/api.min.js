import*as config from"./../config.js";var eStore=null;export{以sql向思源请求块数据 as sql,获取思源块链接锚文本 as getAnchor,删除思源文档 as removeDoc,重命名思源文档 as renameDoc,移动思源文档 as moveDoc,以id获取文档内容 as getDoc,以id获取文档块markdown as exportMdContent,以id获取文档大纲 as getDocOutline,以id获取思源块属性 as getBlockAttrs,设置思源块属性 as setBlockAttrs,列出指定路径下文档 as listDocsByPath,以id获取反向链接 as getBacklink,以sql获取嵌入块内容 as searchEmbedBlock,获取标签列表 as getTag,导出模板 as docSaveAsTemplate,渲染模板 as render,以id获取局部图谱 as getLocalGraph,获取全局图谱 as getGraph,以关键词搜索文档 as searchDocs,以关键词搜索块 as searchBlock,以关键词搜索模板 as searchTemplate,插入前置子块 as prependBlock,插入后置子块 as appendBlock,删除块 as deleteBlock,更新块 as updateBlock,以id获取思源块信息 as getBlockByID,获取块kramdown源码 as getBlockKramdown,获取块面包屑 as getBlockBreadcrumb};export async function request(e,t){let n=null;return await fetch(e,{body:JSON.stringify(t),method:"POST",headers:{Authorization:`Token '${window.siyuan.config.api.token}'`}}).then((function(e){n=e.json()})),n}async function parseRes(e){let t=await e;return 0===t.code?t.data:null}export async function transactions(e,t=[]){const n=new URL(e.ws.ws.url);return parseRes(request("/api/transactions",{app:n.searchParams.get("app"),session:n.searchParams.get("id"),transactions:t}))}async function 以sql向思源请求块数据(e){return parseRes(request("/api/query/sql",{stmt:e}))}async function 获取思源块链接锚文本(e){let t=`select * from blocks where id = '${e=e.replace("((","").replace("))","")}'`,n=await 以sql向思源请求块数据(t),o="";if(n)try{o=n[0][name]?n[0][name]:n[0].content?n[0].content:e}catch(e){o="解析错误"}return o}export async function openNotebook(e){return parseRes(request("/api/notebook/openNotebook",{notebook:e}))}export async function closeNotebook(e){return parseRes(request("/api/notebook/closeNotebook",{notebook:e}))}export async function renameNotebook(e,t){return parseRes(request("/api/notebook/renameNotebook",{notebook:e,name:t}))}export async function createNotebook(e){return parseRes(request("/api/notebook/createNotebook",{name:e}))}export async function removeNotebook(e){return parseRes(request("/api/notebook/removeNotebook",{notebook:e}))}export async function getNotebookConf(e){return parseRes(request("/api/notebook/getNotebookConf",{notebook:e}))}export async function setNotebookConf(e){return parseRes(request("/api/notebook/setNotebookConf",{notebook:e}))}async function 重命名思源文档(e,t,n){return parseRes(request("/api/filetree/renameDoc",{notebook:e,path:t,title:n}))}async function 删除思源文档(e,t){return parseRes(request("/api/filetree/removeDoc",{notebook:e,path:t}))}async function 移动思源文档(e,t,n,o){return parseRes(request("/api/filetree/moveDoc",{fromNotebook:e,fromPath:t,toNotebook:n,toPath:o}))}export async function getHPathByPath(e,t){return parseRes(request("/api/filetree/getHPathByPath",{Notebook:e,Path:t}))}export async function getHPathByID(e){return parseRes(request("/api/filetree/getHPathByID",{id:e}))}async function 以id获取思源块属性(e){return parseRes(request("/api/attr/getBlockAttrs",{id:e}))}async function 以id获取思源块信息(e){let t=`select * from blocks where id ='${e}'`;return(await 以sql向思源请求块数据(t))[0]}async function 获取块kramdown源码(e){return parseRes(request("/api/block/getBlockKramdown",{id:e}))}async function 获取块面包屑(e){return parseRes(request("/api/block/getBlockBreadcrumb",{id:e}))}async function 设置思源块属性(e,t){return parseRes(request("/api/attr/setBlockAttrs",{id:e,attrs:t}))}async function 以id获取文档块markdown(e){return parseRes(request("/api/export/exportMdContent",{id:e}))}async function 以id获取文档大纲(e){return parseRes(request("/api/outline/getDocOutline",{id:e}))}async function 列出指定路径下文档(e){return parseRes(request("/api/filetree/listDocsByPath",{path:e}))}function html转义(e){var t=document.createElement("div");t.innerHTML=e;var n=t.innerText||t.textContent;return t=null,n}async function 以id获取反向链接(e){return parseRes(request("/api/ref/getBacklink",{id:e,beforeLen:10,k:"",mk:""}))}async function 以sql获取嵌入块内容(e,t){return parseRes(request("/api/search/searchEmbedBlock",{stmt:t,excludeIDs:e}))}async function 以id获取文档内容(e){return parseRes(request("/api/filetree/getDoc",{id:e,k:"",mode:2,size:36}))}async function 获取标签列表(){return parseRes(request("/api/tag/getTag",{}))}async function 以id获取局部图谱(e,t,n,o){return parseRes(request("/api/graph/getLocalGraph",{id:t,k:e,conf:n,reqId:o}))}async function 获取全局图谱(e,t,n){return parseRes(request("/api/graph/getGraph",{k:e,conf:t,reqId:n}))}async function 以关键词搜索文档(e){return parseRes(request("/api/filetree/searchDocs",{k:e}))}async function 以关键词搜索块(e){return parseRes(request("/api/search/searchBlock",{query:e}))}async function 以关键词搜索模板(e){return parseRes(request("/api/search/searchTemplate",{k:e}))}export async function createDocWithMd(e,t,n){return parseRes(request("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:n}))}async function 导出模板(e,t=!1){return parseRes(request("/api/template/docSaveAsTemplate",{id:e,overwrite:t}))}async function 渲染模板(e){return parseRes(request("/api/template/render",e))}export async function insertBlock(e,t,n){let o="/api/block/insertBlock";return parseRes(request(o=o,n={previousID:e,dataType:t,data:n}))}async function 插入前置子块(e,t,n){let o="/api/block/prependBlock";return parseRes(request(o=o,n={parentID:e,dataType:t,data:n}))}async function 插入后置子块(e,t,n){let o="/api/block/appendBlock";return parseRes(request(o=o,n={parentID:e,dataType:t,data:n}))}async function 更新块(e,t,n){let o="/api/block/updateBlock";return parseRes(request(o=o,n={id:e,dataType:t,data:n}))}async function 删除块(e){let t="/api/block/deleteBlock";return parseRes(request(t=t,data={id:e}))}export async function getSysFonts(){return parseRes(request("/api/system/getSysFonts"))}export async function getFile(e){const t=await fetch("/api/file/getFile",{method:"POST",headers:{Authorization:`Token ${config.apitoken}`},body:JSON.stringify({path:e})});return 200===t.status?t:null}export async function putFile(e,t,n=!1,o=Date.now()){let r=new Blob([t]),a=new File([r],e.split("/").pop()),s=new FormData;s.append("path",e),s.append("file",a),s.append("isDir",n),s.append("modTime",o);const i=await fetch("/api/file/putFile",{body:s,method:"POST",headers:{Authorization:`Token ${config.apitoken}`}});return 200===i.status?await i.json():null}export function 通知(e,t=7e3){var n=new XMLHttpRequest;n.open("POST","http://127.0.0.1:6806/api/notification/pushMsg",!0),n.setRequestHeader("Content-type","application/json");var o={msg:e,timeout:7e3};n.send(JSON.stringify(o)),n.onreadystatechange=()=>{if(4==n.readyState&&200==n.status)n.responseText}}export function getTextWidth(e,t){var n=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d");return n.font=t,n.measureText(e).width}export function addinsertCreateElement(e,t,n=null){var o=document.createElement(t);return n&&(o.id=n),e.appendChild(o),o}export function insertCreateAfter(e,t,n=null){var o=document.createElement(t);n&&(o.id=n);var r=e.parentNode;return r.lastChild===e?(r.appendChild(o),o):(r.insertBefore(o,e.nextSibling),o)}function AddEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}function myRemoveEvent(e,t,n){e.addEventListener?e.removeEventListener(t,n,!1):e.attachEvent?e.detachEvent("on"+t,n):e["on"+t]=null}function diguiTooONE(e,t){return null==e||null==t?null:function e(n){var o=n.children;if(o.length=0)return null;for(let n=0;n<o.length;n++){const a=o[n];if(t(a))return a;var r=e(a);if(null!=r)return r}return null}(e)}export function getBlockSelected(){let e=document.querySelectorAll(".protyle:not(.fn__none)>.protyle-content .protyle-wysiwyg--select");return 1===e.length&&null!=e[0].dataset.nodeId?{id:e[0].dataset.nodeId,type:e[0].dataset.type,subtype:e[0].dataset.subtype,parentNode:e[0].offsetParent}:null}export function removejscssfile(e,t){for(var n="js"==t?"script":"css"==t?"link":"none",o="js"==t?"src":"css"==t?"href":"none",r=document.getElementsByTagName(n),a=r.length;a>=0;a--)r[a]&&null!=r[a].getAttribute(o)&&-1!=r[a].getAttribute(o).indexOf(e)&&r[a].parentNode.removeChild(r[a])}export function insertCreateBefore(e,t,n=null){var o=document.createElement(t);return n&&(o.id=n),e.parentElement.insertBefore(o,e),o}export function compareVersion(e,t){const n=e.split("."),o=t.split("."),r=n.length,a=o.length,s=Math.min(r,a);let i=0;for(;i<s;i++){let e=parseInt(n[i]),t=parseInt(o[i]);if(e>t)return 1;if(e<t)return-1}if(r>a){for(let e=i;e<r;e++)if(0!=parseInt(n[e]))return 1;return 0}if(r<a){for(let e=i;e<a;e++)if(0!=parseInt(o[e]))return-1;return 0}return 0}export const isPromise=e=>"function"==typeof e.then;export function isEmpty(e){return null==e||""===e}export function isEmptyString(e){return"string"!=typeof e||null===e||""===e||"null"===e||"NULL"===e}export function RangeLimitedInt(e,t,n){var o=parseInt(e,10),r=parseInt(t,10),a=parseInt(n,10),s=r<a?r:a;return o>s?o:s}export function CopyDOM(e,t){var n=document.querySelector(e),o=document.querySelector(t),r=n.cloneNode(!0);o.appendChild(r)}export function MoveDOM(e,t){var n=document.querySelector(e);document.querySelector(t).appendChild(n)}export function MoveChildren(e,t){for(var n=document.querySelector(e),o=n.children,r=n.childElementCount,a=document.querySelector(t),s=0;s<r;s++)a.appendChild(o[0])}export function isDesktopAppMode(){let e=window.document.body.classList;return!e.contains("android")&&(!e.contains("client--browser")&&("windows"==window.siyuan.config.system.os||"darwin"==window.siyuan.config.system.os))}export function isPhoneAppMode(){let e=document.body.classList.contains("body--mobile"),t=document.body.classList.contains("client--siyuan");return!(!e||!t)}export function getTooltipDirection(e){const t=e.getBoundingClientRect(),n=t.left+t.width/2,o=t.top+t.height/2,r=1*document.documentElement.offsetWidth/3,a=2*document.documentElement.offsetWidth/3,s=1*document.documentElement.offsetHeight/3,i=2*document.documentElement.offsetHeight/3;let c;switch(!0){case o<s&&n<r:c="b3-tooltips__se";break;case o<s&&n>=r&&n<=a:c="b3-tooltips__s";break;case o<s&&n>a:c="b3-tooltips__sw";break;case o>=s&&o<=i&&n<r:c="b3-tooltips__e";break;case o>=s&&o<=i&&n>=r&&n<=a:c="b3-tooltips__s";break;case o>=s&&o<=i&&n>a:c="b3-tooltips__w";break;case o>i&&n<r:c="b3-tooltips__ne";break;case o>i&&n>=r&&n<=a:c="b3-tooltips__n";break;case o>i&&n>a:c="b3-tooltips__nw";break;default:break}return c}export function setTooltipDirection(e,...t){const n=["b3-tooltips__nw","b3-tooltips__n","b3-tooltips__ne","b3-tooltips__e","b3-tooltips__se","b3-tooltips__s","b3-tooltips__sw","b3-tooltips__w"];t.forEach((t=>{t.classList.remove(...n),t.classList.add(e(t))}))}export function getFocusedBlock(){if(document.activeElement.classList.contains("protyle-wysiwyg")){let e=window.getSelection()?.focusNode?.parentElement;for(;null!=e&&null==e?.dataset?.nodeId;)e=e.parentElement;return e}return null}export function getFocusedBlockID(){let e=getFocusedBlock();return e?e.dataset.nodeId:null}export function getFocusedDoc(){return document.querySelector("div.layout__wnd--active div.protyle:not(.fn__none) > div.protyle-content > div.protyle-wysiwyg[data-doc-type]")||document.querySelector("#editor > div.protyle-content >  div.protyle-wysiwyg[data-doc-type]")||null}export function getFocusedDocBackground(){for(var e=getFocusedDoc();null!=e&&!1===e.classList.contains("protyle-background");)e=e.previousElementSibling;return e||null}export function getFocusedDocID(){let e=getFocusedDocBackground();return e?e.dataset.nodeId:null}export function getFocusedID(){return getFocusedBlockID()||getFocusedDocID()||null}export function OK(){return!0}export async function getConfigesStore(e){return parseRes(request("http://127.0.0.1:6806/api/sillot/getConfigesStore",e))}export class LimitPromise{constructor(e){this._max=e,this._count=0,this._taskQueue=[]}call(e,...t){return new Promise(((n,o)=>{const r=this._createTask(e,t,n,o);this._count>=this._max?this._taskQueue.push(r):r()}))}_createTask(e,t,n,o){return()=>{e(...t).then(n).catch(o).finally((()=>{if(this._count--,this._taskQueue.length){this._taskQueue.shift()()}})),this._count++}}}export class LocalStorage{constructor(e){this._MAX=e,this.limitP=new LimitPromise(this._MAX)}async getItem(e,t=null){return await this.limitP.call(this.GetItem,e)}async setItem(e,t,n=null){return await this.limitP.call(this.SetItem,e,t,n)}async removeItem(e,t=null){return await this.limitP.call(this.RemoveItem,e,t)}async GetItem(e){return e?await(localforage?.getItem(e).catch((function(e){}))):void 0}async SetItem(e,t,n){return await(localforage?.setItem(e,t).then((function(e){})).catch((function(e){})))}async RemoveItem(e,t){return await(localforage?.removeItem(e).then((()=>{})).catch((function(e){})))}}export const getNewValueFromDomByID=async e=>{let t=document.getElementById(e);return"checkbox"==t.type||"radio"==t.type?t.checked:t.value};export async function initAllPropFromIDBAsync(e){const t=async e=>{let t=document.getElementById(e),n="checkbox"==t.type;Object.defineProperty(t,"bindIDB",{get:()=>n?t.checked:t.value,set:function(o){return n?t.checked="true"===o:t.value=o,localforage.setItem(e,o),!0},configurable:!0}),window.obj3=function(e,t){let n={get(e,n){t.beforeRead(e,n);let o=Reflect.get(e,n);return t.read(e,n),o},set(e,r,a){t.beforeUpdated(a,r,a),e[r]!=a&&t.beforeChanged(a,r,a);let s=Reflect.set(e,r,a);return t.updated(a,r,a),t.changed(a,r,a),"object"==typeof a&&(e[r]=o(e[r],n)),s}};return o(e,n);function o(e,t){return n(e)||function e(t,o){for(let r in t)"object"==typeof t[r]&&(n(t[r])||e(t[r],o),t[r]=new Proxy(t[r],o));t=new Proxy(t,o)}(e,t),new Proxy(e,t);function n(e){if("object"!=typeof e)return!1;for(let t in e)if("object"==typeof e[t])return!1;return!0}}}({name:{second:"99"}},{beforeRead(e,t){},read(e,t){},beforeUpdated(e,t,n){},beforeChanged(e,t,n){},updated(e,t,n){},changed(e,t,n){}}),window.obj3.name.second},n=async e=>{if(!isEmptyString(e))return await t(e),localforage.getItem(e).then((async t=>{let n=document.getElementById(e);if(isEmptyString(t))switch(n.type){case"select-one":case"select-multiple":n.bindIDB=n.options[0].value;break;case"number":case"range":n.bindIDB=0;break;default:n.bindIDB="";break}else n.bindIDB=t}))},o=async(e,t)=>{const n=e.length;let o=0;for(;o<n;)await t(e[o]),o++};let r=0,a=e.querySelectorAll("select:not([id^='NoSync'])"),s=e.querySelectorAll("input[id^='SC_winsay_cp']:not([type='checkbox'])"),i=e.querySelectorAll("input[type='checkbox']:not([id^='NoSync'])");r+=a.length,r+=s.length,r+=i.length,window.winsay.cp.awaitInitItem=r,await o(a,(async e=>{await n(e.id),window.winsay.cp.awaitInitItem-=1,window.winsay.cp.inited+=1})),await o(s,(async e=>{await n(e.id),window.winsay.cp.awaitInitItem-=1,window.winsay.cp.inited+=1})),await o(i,(async e=>{await(async e=>{if(!isEmptyString(e.id))return await t(e.id),localforage.getItem(e.id).then((async t=>{isEmptyString(t)?e.bindIDB="false":e.bindIDB="true"}))})(e),window.winsay.cp.awaitInitItem-=1,window.winsay.cp.inited+=1}))}export async function propChange(e,t){document.getElementById(e).addEventListener("change",(async e=>{"function"==typeof t&&await t(e.target.bindIDB)})),window.winsay.cp.listened+=1}export async function checkedChange(e,t,n){e.addEventListener("click",(async()=>{e.checked&&!0===e.checked?t():n()})),window.winsay.cp.listened+=1}export const SofillDate={isDuringDate:function(e,t){var n=new Date,o=new Date(e),r=new Date(t);return n>=o&&n<=r},isDuringTime:function(e,t){var n=new Date,o=new Date(`${n.getFullYear()}-${n.getMonth()+1}-${n.getDate()} ${e}`),r=new Date(`${n.getFullYear()}-${n.getMonth()+1}-${n.getDate()} ${t}`);if(o<=r){if(o<=n&&n<=r)return!0}else if(o<=n||n<=r)return!0;return!1}};export function getUrlParam(e,t){const n=new URL(e).search.slice(1).split("&");for(let e=0;e<n.length;e++){const o=n[e].split("=");if(o[0]===t)return o[1]}}export const sleep=e=>new Promise((t=>setTimeout(t,e)));export function getUrlParams(e){return new URL(e).search.slice(1).split("&")}export async function getBazaarTheme(e,t,n){return request("http://"+e+"/api/bazaar/getBazaarTheme",t,n)}export async function getInstalledTheme(e,t,n){return request("http://"+e+"/api/bazaar/getInstalledTheme",t,n)}